generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       String    @id @default(uuid())
  name     String
  dob      DateTime?
  mobileNo String?   @unique
  gender   String?
  email    String    @unique
  googleId String?   @unique

  isVerified Boolean @default(false)

  otpHash     String?
  otpExpiry   DateTime?
  otpAttempts Int       @default(0)

  refreshTokenHash String?
  refreshExpiresAt DateTime?

  role    UserRole
  patient Patient?
  doctor  Doctor?
}

model Patient {
  id           String        @id @default(uuid())
  userId       String        @unique
  name         String
  dob          DateTime?
  mobileNo     String?
  gender       String?
  appointments Appointment[]
  user         User          @relation(fields: [userId], references: [id])
}

model Doctor {
  id            String             @id @default(uuid())
  userId        String             @unique
  name          String
  experience    Int?
  fees          Float?
  profileNote   String?
  specializesIn String[]
  services      String[]
  appointments  Appointment[]
  slots         AvailabilitySlot[]
  user          User               @relation(fields: [userId], references: [id])

  recurringRules RecurringRule[]
}

model AvailabilitySlot {
  id        String   @id @default(uuid())

  startTime   DateTime
  endTime     DateTime
  
  durationMin Int     

  capacity    Int     
  bookedCount Int     @default(0)

  sessionType SessionType

  doctorId String
  doctor   Doctor @relation(fields: [doctorId], references: [id])

  ruleId String?
  rule   RecurringRule? @relation(fields: [ruleId], references: [id])

  appointments Appointment[]
}


model Appointment {
  id              String            @id @default(uuid())
  appointmentDate DateTime
  appointmentTime DateTime
  consultingType  ConsultingType
  complaint       String
  visitType       String
  weight          Float?
  recordedAge     Int?
  status          AppointmentStatus
  patientId       String
  doctorId        String
  slotId          String
  doctor          Doctor            @relation(fields: [doctorId], references: [id])
  patient         Patient           @relation(fields: [patientId], references: [id])
  slot            AvailabilitySlot  @relation(fields: [slotId], references: [id])
}

model RecurringRule {
  id        String   @id @default(uuid())

  doctorId  String
  doctor    Doctor   @relation(fields: [doctorId], references: [id])

  weekdayMask Int
  startMin    Int

  durationMin Int   

  capacity Int

  validFrom   DateTime
  validUntil  DateTime?

  sessionType SessionType

  slots AvailabilitySlot[]
}

enum UserRole {
  PATIENT
  DOCTOR
}

enum SessionType {
  ONLINE
  OFFLINE
}

enum AppointmentStatus {
  BOOKED
  CANCELLED
  COMPLETED
}

enum ConsultingType {
  REGULAR
  REVISIT
  FOLLOW_UP
}
